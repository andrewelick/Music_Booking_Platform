<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, intial-scale=1.0">
    <title>Bluff Tour</title>

    <link href="https://fonts.googleapis.com/css?family=Montserrat|Quicksand" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="static/styles.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <style type='text/css'>
      body {
        margin:0;
        padding:0;
        box-sizing: border-box;
        background-color: #f6f9fc;
      }

        .mobilegridrow-2 {
            box-sizing: border-box;
            width: 100%;
            padding: 0;
            padding:10px;
            margin-top: 10px;
            margin-bottom: 20px;
            text-align: center;
            border-color: #d2d2d2;
            background-color: #FFFFFF;
            border-radius: 5px;
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
        }

        #profilecontainer {
            box-sizing: border-box;
            width: 100%;
            padding: 20px;
            overflow: hidden;
        }

        #profilepicture {
          box-sizing: border-box;
          width: 125px;
          border-radius: 100%;
          margin-right: 5px;
          float: left;
        }

        #bio {
            display: inline-block;
            width: 100%;
            font-size: 14px;
            padding: 10px;
            float: left;
            text-align: left;
        }

        .socialbar {
          padding-top: 5px;
        }

        .socialicon {
          height: 25px;
          width: 25px;
          padding: 2px;
        }

        .contact {
            display: inline-block;
            width: 100px;
            padding: 10px;
            margin-top:5px;
            text-decoration: none;
            border-radius: 5px;
            font-size: 12px;
            text-align: center;
            background-color: #328CC1;
            color: #FFFFFF
        }

        #spotify_followers {
            border: 1px solid;
            float: left;
            padding: 4px;
            font-size: 12px;
            border-radius: 5px;
            background-color: #1DB954;
            color: #FFFFFF;
        }

        #editprofile {
            display: inline-block;
            width: 100px;
            padding: 7px;
            margin-top: 10px;
            border-radius: 5px;
            font-size:12px;
            color:#FFFFFF;
            background-color:#328CC1;
            text-align: center
        }

        #musiccontainer {
          color: #383838;
        }

        .youtubevideo {
          width: 100%;
          height: 250px;
          margin-bottom: 15px;
        }

        .topsongcontainer {
          margin-bottom: 3px;
          box-shadow: 0 0px 4px 0 #383838;
        }

        .spotifyalbum {
          margin-right: 3px;
        }

        .albumpicture {
          border: 2px solid;
          border-radius: 5px;
          border-color: #FFFFFF;
          box-shadow: 0 0px 4px 0 #383838;
        }

        textarea {
          padding: 8px;
          width: 70%;
          font-family: inherit;
          border-radius: 5px;
          resize: none;
        }

        input[type="submit"] {
          padding: 10px;
          padding-left: 20px;
          padding-right: 20px;
          margin-right: 10px;
          border-radius: 5px;
          float: right;
          border: 0;
          background-color: #328CC1;
          color: #FFFFFF;
        }

        #contact_send_message_container {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            padding: 5px;
            padding-top: 20px;
            padding-bottom: 20px;
            width: 100%;
            box-sizing: border-box;
            z-index: 99;
            border-radius: 5px;
            text-align: center;
            background-color: #FFFFFF;
            transition: 0.3s;
            overflow: hidden;
            box-shadow: 0 0px 15px 0 #111111;
        }

        #blackbackground {
          position: fixed;
          top: 0px;
          left: 0px;
          z-index:10;
          height:100%;
          width:100%;
          background-color:#000000;
          opacity:.8
        }

        #closesendmessage {
          position: absolute;
          top:10px;
          right:10px;
          padding:5px;
          color:#000000;
        }

        #closesendmessage:hover {
            cursor: pointer;
        }

        .loading_gif {
            height: 50px;
        }

        .media_preview {
            width: 100%;
            border-radius: 5px;
        }

        #add_media_container {
            padding-bottom: 5px;
            font-size: 14px;
        }

        #media_preview_display {
            box-sizing: border-box;
            padding: 15px;
        }


        @media screen and (min-width: 800px) {

            .mobilegridrow-2 {
                width: 800px;
                margin: 0 auto;
            }

            #contact_send_message_container {
                width: 400px;
                margin: 0 auto;
            }

            .youtubevideo {
                height: 350px;
            }

            .albumpicture {
                height: 150px;
            }

            .topsongcontainer {
                width: 480px;
            }

            .socialbar {
                max-width: 350px;
            }

        }

    </style>
  </head>
  <body>
    <!-- Mobile heading -->
    {% include 'header.html' %}

    <div class='mobilegridrow-2'>

        <!--- Profile container --->
        <div id="profilecontainer" class="container">

            <!--- Profile picture --->
            <img src="https://bluffbucket.s3.us-east-2.amazonaws.com/static/user_pictures/profile_pictures/{% print uid %}_profile.jpg" id='profilepicture' />

            <div id="profile_text_container" style="float: left;text-align: left;margin-left: 10px;">
                <!--- Artist name --->
                <span style='font-size: 20px;font-weight:bold;padding-bottom: 10px;'>{% print artist_details[5] %}</span>
                </br>

                <!--- Artist genre and member count --->
                <div style='font-size:14px;'>
                  {% print artist_details[1] %} |

                  {% if artist_details[2] == 1%}
                    {% print "Soloist" %}
                  {% else %}
                    {% print artist_details[2] %} members
                  {% endif %}
                </div>

                <!--- Contact bar --->
                <div id="contactbar">
                    {% if email != session['username'] %}
                        <a href="#" class="contact" id="messageartist">Messsage</a>
                    {% endif %}
                </div>
                <!--- End of contact bar --->

                <!--- Edit profile button --->
                {% if email == session['username'] %}
                    <a href="/editprofile" id="editprofile">Edit profile</a>
                {% endif %}

                <!--- Social bar --->
                <div class="socialbar">
                    <!--- Spotify button --->
                    {% if artist_links[2] != "" and artist_links[2] != None %}
                        <iframe src="https://open.spotify.com/follow/1/?uri=spotify:artist:0iEtIxbK0KxaSlF7G42ZOp&size=basic&theme=light" width="150" height="28" scrolling="no" frameborder="0" style="border:none; overflow:hidden;" allowtransparency="true"></iframe>                    <!--- Soundcloud --->
                        <br/>
                    {% endif %}
                    <!--- Twitter --->
                    {% if artist_links[4] != "" and artist_links[4] != None %}
                        <a href="https://twitter.com/{% print artist_links[4] %}?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-dnt="true" data-show-screen-name="false" data-show-count="true"></a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
                        <br/>
                    {% endif %}
                    <!--- Facebook --->
                    {% if artist_links[6] != "" and artist_links[6] != None %}
                        <iframe src="https://www.facebook.com/plugins/like.php?href=https%3A%2F%2Fwww.facebook.com%2F{% print artist_links[6] %}%2F&width=125&layout=button_count&action=like&size=small&show_faces=false&share=true&height=46&appId" width="125" height="46" style="border:none;overflow:hidden" scrolling="no" frameborder="0" allowTransparency="true" allow="encrypted-media"></iframe>
                        <br/>
                    {% endif %}
                    <!--- Instagram --->
                    {% if artist_links[5] != "" and artist_links[5] != None %}
                        <a href="{% print artist_links[5] %}" target="_blank"><img src="static/instagramicon.png" class="socialicon" /></a>
                    {% endif %}

                </div>
                <!--- End of Social bar --->

            </div>

            <!--- Bio --->
            <div id="bio">{% print artist_details[3] %}</div>

        </div>
        <!--- End of Profile container --->

        <!--- Music container --->
        <div id="musiccontainer" class="container">

            <!---Add media button --->
            {% if email == session['username'] %}
                <div id="add_media">+Add media</div>

                <!--- Container holding media add --->
                <div id='add_media_container'>
                    Add your iFrame or link to your media. Accepted websites: Spotify, Soundcloud, Itunes, Bandcamp
                    <input type='text' id="media_input" placeholder="Iframe or link" />
                    <button id="save_media_button" disabled>Save</button>

                    <div id="media_preview_display"></div>
                </div>
            {% endif %}

            <!--- Youtube video --->
            {% if artist_links[1] != "" and artist_links[1] != "NULL" and artist_links[1] != None %}
                <div style='margin-bottom:10px;font-size:16px;font-weight:bold;'>Music video</div>
                <iframe class="youtubevideo" src="https://www.youtube-nocookie.com/embed/{% print artist_links[1] %}" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            {% endif %}

            <!--- Soundcloud iframe --->
            {% if artist_details[4] != "" and artist_details[4] != "NULL" and artist_details[1] != None %}
                <div style='margin-bottom:10px;font-size:16px;font-weight:bold;'>Soundcloud songs</div>
                <iframe class="media_preview" height="400" scrolling="no" frameborder="no" allow="autoplay" src="{% print artist_details[4] %}"></iframe>
            {% endif %}

            <!--- Spotify albums --->
            <div id="albums_container">
                <div style='margin-bottom:10px;font-size:16px;font-weight:bold;'>Recent Albums</div>

                <div id="spotify_albums">
                    <!--- Loading gif --->
                    <img class="loading_gif" src="static/loading-spinner.gif" />
                </div>
            </div>

            <!--- Top songs from Spotify --->
            <div id="top_tracks_container">
                <div style='margin-top:10px;margin-bottom:10px;font-size:16px;font-weight:bold;'>Top songs on Spotify</div>

                <div id="spotify_top_tracks">
                    <!--- Loading gif --->
                    <img class="loading_gif" src="static/loading-spinner.gif" />
                </div>
            </div>


        </div>
        <!--- End of Music container --->

    </div>
    <!--- End of mobilesplash-2 --->

    {% include 'footer.html' %}

    <!--- Contact send message screen --->
    <div id="contact_send_message_container" style="display:none">
        <div style="padding-bottom: 5px;border-bottom: 1px solid;font-size: 18px;border-color: #d2d2d2;">Send message to:</div>
        <span id="closesendmessage">x</span>

        </br>

        <!--- Message rec profile --->
        <div id="message_rec_profile" style="margin-bottom: 15px;">
            <img src='https://bluffbucket.s3.us-east-2.amazonaws.com/static/user_pictures/profile_pictures/{% print artist_details[0] %}_profile.jpg' style="height:50px;width: 50px;border-radius: 100px" />
            <span class="rec_name" style="display:inline;position:relative;top:-19px;">{% print artist_details[4] %}</span>
        </div>
        <!--- End Message rec profile --->

        <!--- Send message form --->
        <form action="/profile" method="POST">
            <input type="hidden" name="rec_id" value="{% print artist_details[0] %}" />
            <textarea name="send_message" placeholder="Type your message here" rows=2></textarea>
            <input type="submit" value="Send" />
        </form>
        <!--- End of send message form --->

    </div>
    <!--- End of Contact send message screen --->

    <!--- Black background for send messages screen --->
    <div id="blackbackground" style="display:none"></div>
    <!--- End of Black background --->


    <script type="text/javascript">

        //Attach loading gif to any ajax call
        $(document).ajaxStart(function() {
            $(".loading_gif").show();
        });

        $(document).ajaxStop(function() {
            $(".loading_gif").hide();
        });

        $("#messageartist").click(function() {
            $("#contact_send_message_container").show()
            $("#blackbackground").show()
        })

        $("#blackbackground").click(function() {
            $("#contact_send_message_container").hide()
            $("#blackbackground").hide()
        })

        $("#closesendmessage").click(function() {
            $("#contact_send_message_container").hide()
            $("#blackbackground").hide()
        })


        //Get Spotify followers count
        $.ajax({
            url: "/spotify_resources",
            type: "POST",
            data: {
                get_followers: "check",
            },
            dataType: "json",
        }).done(function(data) {

            if (data['success']) {
                let follower_count = data['success']

                console.log(follower_count)

                if (follower_count > 1000000) {
                    first_two_numbers = String(follower_count).substr(0,2)
                    follower_count = first_two_numbers.slice(0, 1) + "." + first_two_numbers.slice(1,2) + "m";
                }
                else {

                    if (follower_count > 100000) {
                        first_three_numbers = String(follower_count).substr(0,3)
                        follower_count = first_three_numbers + "k"
                    }
                    else {

                        if (follower_count > 1000) {
                            first_two_numbers = String(follower_count).substr(0,2)
                            follower_count = first_two_numbers.slice(0, 1) + "." + first_two_numbers.slice(1,2) + "k";
                        }
                    }
                }
                $("#spotify_follow_count").html(follower_count)
            }
            else {
                $("#spotify_followers").hide()
            }
        });

        //Load spotify top albums
        $.ajax({
            url: "/spotify_resources",
            type: "POST",
            data: {
                get_albums: "check"
            },
            dataType: "json"
        }).done(function(data) {

            if (data['success']) {
                console.log(data)

                let albums = data['success']

                //Loop through each song
                for (i = 0; i < albums.length; i++)
                {
                    //Iframe for top song
                    let ablum_single = `<a href="${albums[i][0]}" class="spotifyalbum" target="_blank"><img src="${albums[i][1]}" class="albumpicture" height=95 /></a>`

                    //Add songs to container
                    $("#spotify_albums").append(ablum_single)
                }
            }
            else {
                $("#albums_container").hide();
            }
        })

        //Load spotify top tracks
        $.ajax({
            url: "/spotify_resources",
            type: "POST",
            data: {
                get_top_tracks: "check"
            },
            dataType: "json"
        }).done(function(data) {

            if (data['success']) {

                let top_tracks = data['success']

                //Loop through each song
                for (i = 0; i < top_tracks.length; i++)
                {
                    //Iframe for top song
                    let top_track_single = `<iframe src="https://open.spotify.com/embed/track/${top_tracks[i]}" class="topsongcontainer" width="90%" height="80" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>`

                    //Add songs to container
                    $("#spotify_top_tracks").append(top_track_single)
                }
            }
            else {
                $("#top_tracks_container").hide()
            }
        })

        function load_artist_media() {
            //Load artist media
            $.ajax({
                url: "/artist_media",
                type: "POST",
                data: {
                    type: "nipple",
                    src: "nipple"
                },
                dataType: "json"
            }).done(function(data) {

                console.log(data)
            })
        }

        //Validate new media
        function validate_new_media(iframe) {
            //Try to get url of iframe
            let iframe_val = $(iframe).attr('src')

            //Check if there is a iframe
            if (iframe_val) {
                var iframe_src = iframe_val
            }
            else {
                var iframe_src = iframe
            }

            //Check if there is a valid parsed url
            if (iframe_src.startsWith("https://w.soundcloud.com/player/")) {

                return {
                    "valid_input": true,
                    "src": iframe_src
                }
            }
            else {
                //Return invalid
                return {
                    "valid_input": false
                }
            }
        }

        //Validate and load iFrame preview
        $("#media_input").focusout(function() {
            let media_val = $("#media_input").val()

            //Validate input
            let valid_input_data = validate_new_media(media_val)

            console.log(valid_input_data)

            if (valid_input_data.valid_input) {
                //Put media in preview
                $("#media_preview_display").html(valid_input.src)
            }
            else {
                $("media_preview_display").html("Invaild input")
            }
        })

    </script>

  </body>
</html>
